import React, { useRef } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { ArrowLeft, Download, Target, AlertCircle, CheckCircle2, Layers, Shield, Search, Activity, Zap, Percent, Crown, Clock } from 'lucide-react';
import { Navbar, ScoreCard, CategoryCard, RecommendationCard, ProgressBar } from './SharedComponents';
import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';
import { Helmet } from 'react-helmet-async';

const Results = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const { results, url } = location.state || {};
  const reportRef = useRef(null);

  if (!results) {
    return (
      <div className="min-h-screen bg-[#0F1115] text-white flex items-center justify-center">
        <Helmet>
          <title>Results - AiForNation</title>
        </Helmet>
        <div className="text-center">
          <h2 className="text-2xl font-bold mb-4">No results found</h2>
          <button onClick={() => navigate('/')} className="glass-button py-2 px-6">Go Back</button>
        </div>
      </div>
    );
  }

  const handleDownloadPDF = async () => {
    const input = reportRef.current;
    if (!input) return;

    // Temporary style changes for better PDF rendering
    const originalStyle = input.style.cssText;
    input.style.backgroundColor = '#0F1115';
    input.style.padding = '20px';

    const canvas = await html2canvas(input, {
      scale: 2,
      backgroundColor: '#0F1115',
      useCORS: true,
      logging: false
    });

    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = canvas.width;
    const imgHeight = canvas.height;
    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
    
    // Multi-page logic if content is long
    const imgProps = pdf.getImageProperties(imgData);
    const pdfHeightApprox = (imgProps.height * pdfWidth) / imgProps.width;
    
    // Simplified single page fit or split
    if (pdfHeightApprox > pdfHeight) {
       // Ideally implement multi-page split
       // For this MVP, let's fit width and scroll
       const pageHeight = pdf.internal.pageSize.getHeight();
       let heightLeft = pdfHeightApprox;
       let position = 0;
       
       pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeightApprox);
       heightLeft -= pageHeight;

       while (heightLeft >= 0) {
         position = heightLeft - pdfHeightApprox; // top of page
         pdf.addPage();
         pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeightApprox);
         heightLeft -= pageHeight;
       }
    } else {
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeightApprox);
    }

    pdf.save(`AiForNation-Report-${new Date().toISOString().split('T')[0]}.pdf`);
    
    input.style.cssText = originalStyle;
  };

  return (
    <div className="min-h-screen bg-[#0F1115] text-white font-sans">
      <Helmet>
        <title>Analysis for {url} - AiForNation</title>
        <meta name="description" content={`Detailed AdSense approval analysis report for ${url}. Check your score now at AiForNation.`} />
      </Helmet>

       <div className="fixed inset-0 z-0 overflow-hidden pointer-events-none">
        <div className="absolute -top-[20%] -left-[10%] w-[50%] h-[50%] bg-amber-500/5 rounded-full blur-[150px]" />
        <div className="absolute top-[30%] -right-[10%] w-[40%] h-[40%] bg-orange-500/5 rounded-full blur-[120px]" />
      </div>

      <div className="relative z-10">
        <Navbar />
        
        <main className="max-w-7xl mx-auto px-4 sm:px-6 py-24">
          <div className="mb-8 flex items-center justify-between">
             <button onClick={() => navigate('/')} className="flex items-center gap-2 text-white/60 hover:text-white transition-colors">
               <ArrowLeft className="w-5 h-5" /> Back to Home
             </button>
             <button onClick={handleDownloadPDF} className="glass-button py-2 px-4 flex items-center gap-2 text-sm">
               <Download className="w-4 h-4" /> Download Report
             </button>
          </div>

          <div ref={reportRef} className="animate-fade-in-up bg-[#0F1115]">
              <div className="text-center mb-12">
                 <h1 className="text-3xl font-bold text-white mb-2">Analysis Report</h1>
                 <p className="text-white/60">{url}</p>
                 <p className="text-xs text-white/30 mt-1">Generated by AiForNation</p>
              </div>

              <div className="grid sm:grid-cols-2 gap-6 mb-8">
                <ScoreCard score={results.overallScore} />
                <div className="glass-card p-8">
                  <div className="flex items-center gap-3 mb-4">
                    <Target className="w-6 h-6 text-amber-400" />
                    <h3 className="text-xl font-bold text-white">Critical Issues</h3>
                  </div>
                  {results.criticalIssues && results.criticalIssues.length > 0 ? (
                    <ul className="space-y-3">
                      {results.criticalIssues.map((issue, i) => (
                        <li key={i} className="flex items-start gap-2 text-red-300">
                          <AlertCircle className="w-5 h-5 text-red-400 mt-0.5" />
                          {issue}
                        </li>
                      ))}
                    </ul>
                  ) : (
                    <div className="flex items-center gap-2 text-emerald-400">
                      <CheckCircle2 className="w-5 h-5" />
                      <span className="font-medium">No critical issues found!</span>
                    </div>
                  )}
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                <CategoryCard title="Content Depth" data={results.contentDepth} maxScore={50} icon={Layers} color="bg-amber-500" />
                <CategoryCard title="Required Pages" data={results.requiredPages} maxScore={30} icon={Shield} color="bg-emerald-500" />
                <CategoryCard title="Policy" data={results.policyCompliance} maxScore={30} icon={CheckCircle2} color="bg-teal-500" />
                <CategoryCard title="Technical SEO" data={results.technicalSEO} maxScore={40} icon={Search} color="bg-orange-500" />
                <CategoryCard title="Quality" data={results.contentQuality} maxScore={30} icon={Layers} color="bg-rose-500" />
                <CategoryCard title="Mobile" data={results.mobileOptimization} maxScore={25} icon={Activity} color="bg-cyan-500" />
                <CategoryCard title="Performance" data={results.performanceMetrics} maxScore={25} icon={Zap} color="bg-violet-500" />
                <CategoryCard title="Security" data={results.securityScore} maxScore={20} icon={Shield} color="bg-green-500" />
                <CategoryCard title="UX Design" data={results.uxDesign} maxScore={25} icon={Target} color="bg-purple-500" />
                <CategoryCard title="Readiness" data={results.monetizationReadiness} maxScore={25} icon={Percent} color="bg-amber-600" />
              </div>

              <div className="mb-8">
                <h3 className="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                  <Target className="w-6 h-6 text-amber-400" />
                  Priority Recommendations
                </h3>
                <div className="grid sm:grid-cols-2 gap-4">
                  {results.recommendations?.map((rec, i) => (
                    <RecommendationCard key={i} {...rec} />
                  ))}
                </div>
              </div>

              <div className="mb-8">
                <h3 className="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                  <Clock className="w-6 h-6 text-amber-400" />
                  4-Week Improvement Plan
                </h3>
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                  {results.improvements?.map((phase, i) => (
                    <ProgressBar key={i} week={phase.phase} tasks={phase.tasks} isActive={i === 0} />
                  ))}
                </div>
              </div>
          </div>
        </main>
      </div>
    </div>
  );
};

export default Results;
